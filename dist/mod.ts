function y(n,t="r\xF3"){if(!n.startsWith(`urn:${t}:`))throw new Error(`Invalid URN for namespace ${t}: ${n}`);let r=n.split(":")[2],[e,i]=n.split("?"),s=e.split(":")[3],p=i?Object.fromEntries(new URLSearchParams(i)):{};return{type:r,id:s,qs:p}}function g(n,t="r\xF3"){try{return y(n,t)}catch{return{type:"unknown",id:n,qs:{}}}}var u=class{triples;sourceType;sourceId;sourceQs;relations;targetType;targetId;targetQs;constructor(t){this.triples=t,this.sourceType=new Map,this.sourceId=new Map,this.sourceQs=new Map,this.relations=new Map,this.targetType=new Map,this.targetId=new Map,this.targetQs=new Map,this.indexTriples()}indexTriples(){for(let t=0;t<this.triples.length;t++)this.indexTriple(this.triples[t],t)}indexTriple(t,r){let e=g(c.source(t)),i=c.relation(t),s=g(c.target(t));this.sourceType.has(e.type)||this.sourceType.set(e.type,new Set),this.sourceType.get(e.type).add(r),this.sourceId.has(e.id)||this.sourceId.set(e.id,new Set),this.sourceId.get(e.id).add(r);for(let[p,a]of Object.entries(e.qs))this.sourceQs.has(`${p}=${a}`)||this.sourceQs.set(`${p}=${a}`,new Set),this.sourceQs.get(`${p}=${a}`).add(r);this.relations.has(i)||this.relations.set(i,new Set),this.relations.get(i).add(r),this.targetType.has(s.type)||this.targetType.set(s.type,new Set),this.targetType.get(s.type).add(r),this.targetId.has(s.id)||this.targetId.set(s.id,new Set),this.targetId.get(s.id).add(r);for(let[p,a]of Object.entries(s.qs))this.targetQs.has(`${p}=${a}`)||this.targetQs.set(`${p}=${a}`,new Set),this.targetQs.get(`${p}=${a}`).add(r)}add(t){let r=this.triples.length;this.triples.push(...t);for(let e=0;e<t.length;e++)this.indexTriple(t[e],r+e)}};var d=class{static intersection(t){if(t.length===0)return new Set;t.sort((e,i)=>e.size-i.size);let r=new Set(t[0]);for(let e=1;e<t.length;e++){let i=t[e];for(let s of r)i.has(s)||r.delete(s);if(r.size===0)break}return r}};var c=class{static source(t){return t[0]}static relation(t){return t[1]}static target(t){return t[2]}},f=class n{index;triplesCount;constructor(t){this.index=new u(t),this.triplesCount=t.length}static of(t){return new n(t)}static from(t){let r=[];for(let e of t){let{id:i,...s}=e;for(let[p,a]of Object.entries(s))if(Array.isArray(a))for(let o of a)r.push([i,p,o]);else r.push([i,p,a])}return new n(r)}add(t){this.index.add(t),this.triplesCount+=t.length}map(t){return new n(this.index.triples.map(t))}flatMap(t){let r=this.index.triples.flatMap(t);return new n(r)}first(){return this.index.triples.length>0?this.index.triples[0]:void 0}triples(){return this.index.triples}sources(){return new Set(this.index.triples.map(t=>c.source(t)))}relations(){return new Set(this.index.triples.map(t=>c.relation(t)))}targets(){return new Set(this.index.triples.map(t=>c.target(t)))}objects(){let t={};for(let[e,i,s]of this.index.triples)t[e]||(t[e]={}),t[e][i]?Array.isArray(t[e][i])?t[e][i].push(s):t[e][i]=[t[e][i],s]:t[e][i]=s;let r=[];for(let[e,i]of Object.entries(t))i.id=e,r.push(i);return r}search(t){let r=[new Set(Array.from({length:this.triplesCount},(o,l)=>l))],e=t.source,i=t.relation,s=t.target;if(e){if(e.type){let o=this.index.sourceType.get(e.type);if(o)r.push(o);else return new n([])}if(e.id){let o=this.index.sourceId.get(e.id);if(o)r.push(o);else return new n([])}if(e.qs)for(let[o,l]of Object.entries(e.qs)){let h=this.index.sourceQs.get(`${o}=${l}`);if(h)r.push(h);else return new n([])}}if(s){if(s.type){let o=this.index.targetType.get(s.type);if(o)r.push(o);else return new n([])}if(s.id){let o=this.index.targetId.get(s.id);if(o)r.push(o);else return new n([])}if(s.qs)for(let[o,l]of Object.entries(s.qs)){let h=this.index.targetQs.get(`${o}=${l}`);if(h)r.push(h);else return new n([])}}if(i){let o=this.index.relations.get(i);if(o)r.push(o);else return new n([])}let p=d.intersection(r),a=[];for(let o of p){let l=this.index.triples[o];if(e?.predicate||s?.predicate){let h=e?.predicate?e.predicate(c.source(l)):!0,T=s?.predicate?s.predicate(c.target(l)):!0;h&&T&&a.push(l)}else a.push(l)}return new n(a)}searchArray(t){return this.search(t).triples()}};export{f as TribbleDB,c as Triples};
//# sourceMappingURL=mod.ts.map
