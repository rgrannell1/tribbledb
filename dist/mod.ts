function S(d,e="r\xF3"){if(!d.startsWith(`urn:${e}:`))throw new Error(`Invalid URN for namespace ${e}: ${d}`);let t=d.split(":")[2],[r,i]=d.split("?"),n=r.split(":")[3],g=i?Object.fromEntries(new URLSearchParams(i)):{};return{type:t,id:n,qs:g}}function I(d,e="r\xF3"){try{return S(d,e)}catch{return{type:"unknown",id:d,qs:{}}}}var o=class{static source(e){return e[0]}static relation(e){return e[1]}static target(e){return e[2]}};var c=class{#t;#e;#r;constructor(){this.#t=0,this.#e=new Map,this.#r=new Map}map(){return this.#e}reverseMap(){return this.#r}add(e){return this.#e.has(e)?this.#e.get(e):(this.#e.set(e,this.#t),this.#r.set(this.#t,e),this.#t++,this.#t-1)}getIndex(e){return this.#e.get(e)}getValue(e){return this.#r.get(e)}has(e){return this.#e.has(e)}},l=class{static intersection(e){if(e.length===0)return new Set;e.sort((r,i)=>r.size-i.size);let t=new Set(e[0]);for(let r=1;r<e.length;r++){let i=e[r];for(let n of t)i.has(n)||t.delete(n);if(t.size===0)break}return t}};var f=class{indexedTriples;stringIndex;sourceType;sourceId;sourceQs;relations;targetType;targetId;targetQs;constructor(e){this.indexedTriples=[],this.stringIndex=new c,this.sourceType=new Map,this.sourceId=new Map,this.sourceQs=new Map,this.relations=new Map,this.targetType=new Map,this.targetId=new Map,this.targetQs=new Map,this.indexTriples(e)}indexTriples(e){for(let t=0;t<e.length;t++)this.indexTriple(e[t],t)}indexTriple(e,t){let r=I(o.source(e)),i=o.relation(e),n=I(o.target(e)),g=this.stringIndex.add(r.type),u=this.stringIndex.add(r.id),s=this.stringIndex.add(i),p=this.stringIndex.add(n.type),a=this.stringIndex.add(n.id);this.indexedTriples.push([this.stringIndex.add(o.source(e)),s,this.stringIndex.add(o.target(e))]),this.sourceType.has(g)||this.sourceType.set(g,new Set),this.sourceType.get(g).add(t),this.sourceId.has(u)||this.sourceId.set(u,new Set),this.sourceId.get(u).add(t);for(let[x,T]of Object.entries(r.qs)){let h=this.stringIndex.add(`${x}=${T}`);this.sourceQs.has(h)||this.sourceQs.set(h,new Set),this.sourceQs.get(h).add(t)}this.relations.has(s)||this.relations.set(s,new Set),this.relations.get(s).add(t),this.targetType.has(p)||this.targetType.set(p,new Set),this.targetType.get(p).add(t),this.targetId.has(a)||this.targetId.set(a,new Set),this.targetId.get(a).add(t);for(let[x,T]of Object.entries(n.qs)){let h=this.stringIndex.add(`${x}=${T}`);this.targetQs.has(h)||this.targetQs.set(h,new Set),this.targetQs.get(h).add(t)}}add(e){let t=this.indexedTriples.length;for(let r=0;r<e.length;r++)this.indexTriple(e[r],t+r)}get length(){return this.indexedTriples.length}triples(){return this.indexedTriples.map(([e,t,r])=>[this.stringIndex.getValue(e),this.stringIndex.getValue(t),this.stringIndex.getValue(r)])}getTriple(e){if(e<0||e>=this.indexedTriples.length)return;let[t,r,i]=this.indexedTriples[e];return[this.stringIndex.getValue(t),this.stringIndex.getValue(r),this.stringIndex.getValue(i)]}getSourceTypeSet(e){let t=this.stringIndex.getIndex(e);return t!==void 0?this.sourceType.get(t):void 0}getSourceIdSet(e){let t=this.stringIndex.getIndex(e);return t!==void 0?this.sourceId.get(t):void 0}getSourceQsSet(e,t){let r=this.stringIndex.getIndex(`${e}=${t}`);return r!==void 0?this.sourceQs.get(r):void 0}getRelationSet(e){let t=this.stringIndex.getIndex(e);return t!==void 0?this.relations.get(t):void 0}getTargetTypeSet(e){let t=this.stringIndex.getIndex(e);return t!==void 0?this.targetType.get(t):void 0}getTargetIdSet(e){let t=this.stringIndex.getIndex(e);return t!==void 0?this.targetId.get(t):void 0}getTargetQsSet(e,t){let r=this.stringIndex.getIndex(`${e}=${t}`);return r!==void 0?this.targetQs.get(r):void 0}};var m=class d{index;triplesCount;tripleRows;constructor(e){this.index=new f(e),this.triplesCount=this.index.length,this.tripleRows=new Set;for(let t=0;t<this.triplesCount;t++)this.tripleRows.add(t)}static of(e){return new d(e)}static from(e){let t=[];for(let r of e){let{id:i,...n}=r;if(typeof i!="string")throw new Error("Each TripleObject must have a string id.");for(let[g,u]of Object.entries(n))if(Array.isArray(u))for(let s of u)t.push([i,g,s]);else t.push([i,g,u])}return new d(t)}add(e){let t=this.index.length;this.index.add(e),this.triplesCount=this.index.length;for(let r=t;r<this.triplesCount;r++)this.tripleRows.add(r)}map(e){return new d(this.index.triples().map(e))}flatMap(e){let t=this.index.triples().flatMap(e);return new d(t)}firstTriple(){return this.index.length>0?this.index.getTriple(0):void 0}firstSource(){let e=this.firstTriple();return e?o.source(e):void 0}firstRelation(){let e=this.firstTriple();return e?o.relation(e):void 0}firstTarget(){let e=this.firstTriple();return e?o.target(e):void 0}firstObject(){return this.objects()[0]}triples(){return this.index.triples()}sources(){return new Set(this.index.triples().map(o.source))}relations(){return new Set(this.index.triples().map(o.relation))}targets(){return new Set(this.index.triples().map(o.target))}objects(){let e={};for(let[r,i,n]of this.index.triples())e[r]||(e[r]={}),e[r][i]?Array.isArray(e[r][i])?e[r][i].push(n):e[r][i]=[e[r][i],n]:e[r][i]=n;let t=[];for(let[r,i]of Object.entries(e))i.id=r,t.push(i);return t}search(e){let t=[this.tripleRows],{source:r,relation:i,target:n}=e;if(r){if(r.type){let s=this.index.getSourceTypeSet(r.type);if(s)t.push(s);else return new d([])}if(r.id){let s=this.index.getSourceIdSet(r.id);if(s)t.push(s);else return new d([])}if(r.qs)for(let[s,p]of Object.entries(r.qs)){let a=this.index.getSourceQsSet(s,p);if(a)t.push(a);else return new d([])}}if(n){if(n.type){let s=this.index.getTargetTypeSet(n.type);if(s)t.push(s);else return new d([])}if(n.id){let s=this.index.getTargetIdSet(n.id);if(s)t.push(s);else return new d([])}if(n.qs)for(let[s,p]of Object.entries(n.qs)){let a=this.index.getTargetQsSet(s,p);if(a)t.push(a);else return new d([])}}if(i){let s=this.index.getRelationSet(i);if(s)t.push(s);else return new d([])}let g=l.intersection(t),u=[];for(let s of g){let p=this.index.getTriple(s);if(!r?.predicate&&!n?.predicate){u.push(p);continue}let a=!0;r?.predicate&&(a=a&&r.predicate(o.source(p))),n?.predicate&&(a=a&&n.predicate(o.target(p))),a&&u.push(p)}return new d(u)}};export{m as TribbleDB,I as asUrn,S as parseUrn};
//# sourceMappingURL=mod.ts.map
